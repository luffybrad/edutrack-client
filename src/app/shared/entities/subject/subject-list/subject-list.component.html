<app-loading-overlay [show]="loading"></app-loading-overlay>

<!-- Page Header -->
<div class="flex justify-between items-center mb-6">
  <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
    Subjects
  </h2>

  <button *ngIf="(role$ | async) === RoleType.Admin" (click)="openModal('add')"
    class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
    Add Subject
  </button>
</div>

<!-- Search -->
<div class="mb-6 w-full relative">
  <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
  <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="triggerSearch()" placeholder="Search by Subject Name"
    class="w-full pl-10 pr-10 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
  <button *ngIf="searchTerm" (click)="clearSearch()"
    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500">
    <i class="fas fa-times-circle"></i>
  </button>
</div>

<!-- Bulk Delete -->
<div *ngIf="(role$ | async) === RoleType.Admin && selectedIds.length" class="mb-4 flex justify-between items-center">
  <span class="text-sm text-gray-600">Selected: {{ selectedIds.length }}</span>
  <button (click)="bulkDeleteSelected()" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
    Delete Selected
  </button>
</div>

<!-- Subjects Table -->
<div class="overflow-x-auto bg-white rounded shadow">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-3">
          <input type="checkbox" [checked]="allSelected" (change)="toggleSelectAll($event)" />
        </th>
        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total Students</th>
        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
      </tr>
    </thead>

    <tbody class="bg-white divide-y divide-gray-200">
      <tr *ngFor="let subject of filteredSubjects" class="hover:bg-gray-50 transition">
        <td class="px-4 py-3">
          <input type="checkbox" [(ngModel)]="subject.selected" />
        </td>
        <td class="px-4 py-3">{{ subject.name.toUpperCase() }}</td>
        <td class="px-4 py-3">{{ subject.totalStudents || 0 }}</td>
        <td class="px-4 py-3 flex gap-3">
          <ng-container *ngIf="(role$ | async) === RoleType.Admin">
            <button (click)="openModal('edit', subject)"
              class="text-yellow-600 hover:text-yellow-800 flex items-center gap-1">
              <i class="fas fa-edit"></i>
            </button>
            <!-- Assign Class button -->
            <button (click)="assignClasses(subject)"
              class="text-green-600 hover:text-green-800 flex items-center gap-1">
              <i class="fas fa-link"></i>
              Assign Class
            </button>
            <button (click)="deleteSubject(subject.id!)"
              class="text-red-600 hover:text-red-800 flex items-center gap-1">
              <i class="fas fa-trash-alt"></i>
            </button>
          </ng-container>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Add/Edit Modal -->
<div *ngIf="modalMode" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md relative">
    <h3 class="text-2xl font-bold mb-6 text-gray-800">
      {{ modalMode === 'add' ? 'Add Subject' : 'Edit Subject' }}
    </h3>

    <input *ngIf="selectedSubject" [(ngModel)]="selectedSubject.name" (keypress)="allowLettersOnly($event)"
      class="uppercase border border-gray-300 rounded px-3 py-2 w-full focus:ring focus:ring-blue-100" />

    <div class="flex justify-end gap-2 mt-4">
      <button (click)="closeModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">
        Cancel
      </button>
      <button (click)="saveSubject()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Save
      </button>
    </div>
  </div>
</div>