<div class="p-6 bg-white rounded-lg shadow-lg">

    <h1 class="text-2xl font-bold text-blue-600 mb-4">Fee Arrears Dashboard</h1>

    <!-- Toolbar -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
        <input type="text" placeholder="Search by student name..." [(ngModel)]="searchTerm"
            class="px-3 py-2 border rounded w-full md:w-1/3" />
        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2"
            (click)="openCreateModal()">
            <i class="fas fa-plus"></i> New Fee Arrear
        </button>
    </div>

    <!-- Chart -->
    <div class="mb-6 max-w-md mx-auto">
        <canvas baseChart [data]="balanceChartData" [options]="chartOptions" chartType="doughnut"></canvas>
    </div>

    <!-- Fee Arrears Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
            <thead class="bg-blue-100">
                <tr>
                    <th class="py-2 px-4 text-left">Student Name</th>
                    <th class="py-2 px-4">Amount Due</th>
                    <th class="py-2 px-4">Total Paid</th>
                    <th class="py-2 px-4">Balance</th>
                    <th class="py-2 px-4">Status</th>
                    <th class="py-2 px-4">Balance %</th>
                    <th class="py-2 px-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let arrear of filteredArrears()" class="border-b hover:bg-blue-50">
                    <td class="py-2 px-4">{{ getStudentName(arrear.studentId) }}</td>
                    <td class="py-2 px-4">{{ arrear.amountDue | currency:'KES':'symbol':'1.2-2' }}</td>
                    <td class="py-2 px-4">{{ arrear.totalPaid | currency:'KES':'symbol':'1.2-2' }}</td>
                    <td class="py-2 px-4">{{ arrear.balance | currency:'KES':'symbol':'1.2-2' }}</td>
                    <td class="py-2 px-4">
                        <span [ngClass]="arrear.status === 'paid' ? 'text-green-600' : 'text-yellow-600'">
                            {{ arrear.status || 'pending' }}
                        </span>
                    </td>
                    <td class="py-2 px-4">{{ arrear.balancePercentage.toFixed(2) }}%</td>
                    <td class="py-2 px-4 flex gap-2">
                        <button class="text-blue-600 hover:text-blue-800" (click)="openEditModal(arrear)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800" (click)="confirmDelete(arrear)">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="text-green-600 hover:text-green-800" (click)="openTransactionModal(arrear)">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="text-gray-600 hover:text-gray-800" (click)="viewTransactions(arrear)">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="text-purple-600 hover:text-purple-800" (click)="viewAuditLogs(arrear)">
                            <i class="fas fa-history"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Transactions Panel -->
    <div *ngIf="transactions.length" class="mt-6">
        <h3 class="text-lg font-bold mb-2">Transactions</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4">Transaction Code</th>
                        <th class="py-2 px-4">Amount Paid</th>
                        <th class="py-2 px-4">Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let tx of transactions" class="border-b">
                        <td class="py-2 px-4">{{ tx.transactionCode }}</td>
                        <td class="py-2 px-4">{{ tx.amountPaid | currency:'KES':'symbol':'1.2-2' }}</td>
                        <td class="py-2 px-4">{{ tx.createdAt | date:'short' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Audit Logs Panel -->
    <div *ngIf="auditLogs.length" class="mt-6">
        <h3 class="text-lg font-bold mb-2">Audit Logs</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-2 px-4">Action</th>
                        <th class="py-2 px-4">Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let log of auditLogs" class="border-b">
                        <td class="py-2 px-4">{{ log.action }}</td>
                        <td class="py-2 px-4">{{ log.createdAt | date:'short' }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Fee Modal -->
    <div *ngIf="showFeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold text-blue-600 mb-4">
                {{ selectedArrear ? 'Edit Fee Arrear' : 'Create Fee Arrear' }}
            </h2>
            <form [formGroup]="feeForm" (ngSubmit)="submitFeeForm()">
                <label class="block mb-2 font-medium">Student</label>
                <select formControlName="studentId" class="w-full mb-3 px-3 py-2 border rounded"
                    [disabled]="!!selectedArrear">
                    <option value="" disabled>Select Student</option>
                    <option *ngFor="let student of students" [value]="student.id">
                        {{ student.name }} ({{ student.admNo }})
                    </option>
                </select>

                <label class="block mb-2 font-medium">Amount Due</label>
                <input formControlName="amountDue" type="number" placeholder="Amount Due"
                    class="w-full mb-3 px-3 py-2 border rounded" />

                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="px-4 py-2 bg-gray-200 rounded"
                        (click)="showFeeModal=false">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">
                        {{ selectedArrear ? 'Update' : 'Create' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div *ngIf="showTransactionModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold text-green-600 mb-4">Add Transaction</h2>
            <form [formGroup]="transactionForm" (ngSubmit)="submitTransaction()">
                <label class="block mb-2 font-medium">Transaction Code</label>
                <input formControlName="transactionCode" placeholder="Transaction Code"
                    class="w-full mb-3 px-3 py-2 border rounded" />

                <label class="block mb-2 font-medium">Amount Paid</label>
                <input formControlName="amountPaid" type="number" placeholder="Amount Paid"
                    class="w-full mb-3 px-3 py-2 border rounded" />

                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="px-4 py-2 bg-gray-200 rounded"
                        (click)="showTransactionModal=false">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div *ngIf="showDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 class="text-xl font-bold text-red-600 mb-4">Confirm Delete</h2>
            <p>Are you sure you want to delete this fee arrear?</p>
            <div class="flex justify-end gap-2 mt-4">
                <button class="px-4 py-2 bg-gray-200 rounded" (click)="showDeleteModal=false">Cancel</button>
                <button class="px-4 py-2 bg-red-600 text-white rounded" (click)="deleteArrear()">Delete</button>
            </div>
        </div>
    </div>

</div>