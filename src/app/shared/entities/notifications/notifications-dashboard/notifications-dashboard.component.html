<!-- src/app/shared/entities/notifications/notifications-dashboard/notifications-dashboard.component.html -->

<div class="min-h-screen bg-gradient-to-br from-indigo-50/30 to-purple-50/30 py-8 px-4">
    <div class="mx-auto">

        <!-- Enhanced Header Section with Quick Actions -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-6 rounded-2xl shadow-2xl mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="p-3.5 bg-white/10 backdrop-blur-sm rounded-xl">
                        <i class="fas fa-bell text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Notification Dashboard</h1>
                        <p class="text-indigo-100 mt-2 flex items-center gap-2">
                            <i class="fas fa-comments"></i>
                            Manage, track, and respond to messages and notifications
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="px-4 py-2 bg-white/10 backdrop-blur-sm rounded-xl text-white text-sm">
                        <i class="fas fa-clock mr-2"></i>
                        {{ currentUserRole | titlecase }} Dashboard
                    </span>
                </div>
            </div>
        </div>

        <!-- Dashboard Metrics with Enhanced Visuals -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div
                class="bg-white rounded-2xl border border-indigo-100 shadow-sm p-6 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 flex items-center gap-2">
                            <i class="fas fa-inbox text-indigo-500"></i>
                            Total Received
                        </p>
                        <p class="text-3xl font-bold text-gray-800 mt-2">{{ stats?.totalReceived || 0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">All time</p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-indigo-100 to-indigo-50 rounded-2xl">
                        <i class="fas fa-inbox text-indigo-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-2xl border border-indigo-100 shadow-sm p-6 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 flex items-center gap-2">
                            <i class="fas fa-envelope text-red-500"></i>
                            Unread
                        </p>
                        <div class="flex items-end gap-2 mt-2">
                            <p class="text-3xl font-bold text-red-600">{{ unreadCount }}</p>
                            <span class="text-xs text-gray-500 mb-1">need attention</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            {{ readPercentage | number:'1.0-1' }}% read rate
                        </p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-red-100 to-red-50 rounded-2xl relative">
                        <i class="fas fa-envelope text-red-600 text-2xl"></i>
                        <span *ngIf="unreadCount > 0"
                            class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 border-2 border-white rounded-full flex items-center justify-center text-white text-xs font-bold animate-pulse">
                            {{ unreadCount > 99 ? '99+' : unreadCount }}
                        </span>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-2xl border border-indigo-100 shadow-sm p-6 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 flex items-center gap-2">
                            <i class="fas fa-paper-plane text-green-500"></i>
                            Total Sent
                        </p>
                        <p class="text-3xl font-bold text-gray-800 mt-2">{{ stats?.totalSent || 0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">{{ sentNotifications.length }} active</p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-green-100 to-green-50 rounded-2xl">
                        <i class="fas fa-paper-plane text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-2xl border border-indigo-100 shadow-sm p-6 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 flex items-center gap-2">
                            <i class="fas fa-comments text-purple-500"></i>
                            Conversations
                        </p>
                        <p class="text-3xl font-bold text-gray-800 mt-2">{{ conversations.length }}</p>
                        <p class="text-xs text-gray-500 mt-1">active threads</p>
                    </div>
                    <div class="p-4 bg-gradient-to-br from-purple-100 to-purple-50 rounded-2xl">
                        <i class="fas fa-comments text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Sidebar: Enhanced Conversations -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl border border-indigo-100 shadow-lg overflow-hidden sticky top-4">
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-indigo-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-comments text-indigo-600"></i>
                                Recent Conversations
                            </h3>
                            <span
                                class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium shadow-sm">
                                {{ conversations.length }} active
                            </span>
                        </div>
                    </div>

                    <div class="divide-y divide-indigo-50 max-h-[600px] overflow-y-auto">
                        <div *ngFor="let conv of conversations"
                            class="p-4 hover:bg-indigo-50/80 cursor-pointer transition-all duration-200 relative group"
                            [ngClass]="{'bg-indigo-50/90': selectedConversation === conv}"
                            (click)="selectConversation(conv)">

                            <div class="flex items-start gap-3">
                                <!-- Enhanced Avatar with Initials -->
                                <div class="relative flex-shrink-0">
                                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-all bg-gradient-to-br"
                                        [ngClass]="getParticipantAvatarColor(conv.participantRole)">
                                        <span class="text-white font-semibold text-sm">
                                            {{ getParticipantInitials(conv) }}
                                        </span>
                                    </div>
                                    <span *ngIf="conv.unreadCount > 0"
                                        class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 border-2 border-white rounded-full flex items-center justify-center text-white text-xs font-bold animate-pulse">
                                        {{ conv.unreadCount }}
                                    </span>
                                </div>

                                <div class="flex-1 min-w-0">
                                    <!-- Participant Name and Timestamp -->
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="flex items-center gap-2 min-w-0">
                                            <h4 class="font-semibold text-gray-900 truncate">
                                                {{ getParticipantDisplay(conv) }}
                                            </h4>
                                            <!-- Role Badge -->
                                            <span class="text-xs px-2 py-0.5 rounded-full flex-shrink-0"
                                                [ngClass]="getParticipantRoleBadge(conv.participantRole)">
                                                {{ conv.participantRole }}
                                            </span>
                                            <!-- Edited Badge -->
                                            <span *ngIf="conv.lastMessage.isEdited"
                                                class="text-xs text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full flex-shrink-0">
                                                <i class="fas fa-pencil-alt mr-1"></i>edited
                                            </span>
                                        </div>
                                        <span
                                            class="text-xs text-gray-500 bg-white px-2 py-1 rounded-full shadow-sm flex-shrink-0 ml-2">
                                            {{ formatTime(conv.lastMessage.createdAt) }}
                                        </span>
                                    </div>

                                    <!-- Last Message Preview -->
                                    <p class="text-sm text-gray-600 truncate font-medium mb-2">
                                        {{ conv.lastMessage.content }}
                                    </p>

                                    <!-- Message Metadata -->
                                    <div class="flex items-center gap-2 text-xs">
                                        <!-- Message Type Badge -->
                                        <span *ngIf="conv.lastMessage.type === NotificationType.ALERT"
                                            class="px-2 py-1 bg-red-100 text-red-600 rounded-full inline-flex items-center">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>
                                            Alert
                                        </span>
                                        <span *ngIf="conv.lastMessage.type === NotificationType.REMINDER"
                                            class="px-2 py-1 bg-yellow-100 text-yellow-600 rounded-full inline-flex items-center">
                                            <i class="fas fa-bell mr-1"></i>
                                            Reminder
                                        </span>
                                        <span *ngIf="conv.lastMessage.type === NotificationType.SYSTEM"
                                            class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full inline-flex items-center">
                                            <i class="fas fa-cog mr-1"></i>
                                            System
                                        </span>
                                        <span *ngIf="conv.lastMessage.type === NotificationType.MESSAGE"
                                            class="px-2 py-1 bg-blue-100 text-blue-600 rounded-full inline-flex items-center">
                                            <i class="fas fa-envelope mr-1"></i>
                                            Message
                                        </span>

                                        <!-- Attachment Indicator -->
                                        <span *ngIf="conv.lastMessage.attachmentUrl"
                                            class="px-2 py-1 bg-purple-100 text-purple-600 rounded-full inline-flex items-center">
                                            <i class="fas fa-paperclip mr-1"></i>
                                            Attachment
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div *ngIf="conversations.length === 0" class="p-12 text-center">
                            <div
                                class="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-50 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
                                <i class="fas fa-comments text-gray-400 text-3xl"></i>
                            </div>
                            <p class="text-gray-700 font-medium mb-1">No conversations yet</p>
                            <p class="text-sm text-gray-500 mb-4">Start messaging to see conversations here</p>
                            <button
                                class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm hover:from-indigo-700 hover:to-purple-700 transition-all"
                                (click)="openComposeModal()">
                                <i class="fas fa-plus-circle mr-1"></i>
                                Start Conversation
                            </button>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-4 border-t border-indigo-100 bg-gradient-to-r from-indigo-50/50 to-purple-50/50">
                        <button
                            class="w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                            (click)="navigateToAllNotifications()">
                            <i class="fas fa-external-link-alt"></i>
                            View All Conversations
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Enhanced Main Content -->
            <div class="lg:col-span-3">
                <!-- Enhanced Tabs Navigation -->
                <div class="bg-white rounded-2xl border border-indigo-100 shadow-lg mb-6 overflow-hidden">
                    <div class="flex border-b border-indigo-100">
                        <button class="flex-1 px-6 py-4 text-sm font-medium transition-all duration-200 relative group"
                            [ngClass]="activeTab === 'inbox' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            (click)="activeTab = 'inbox'">
                            <i class="fas fa-inbox mr-2"></i>
                            Inbox
                            <span *ngIf="unreadCount > 0"
                                class="ml-2 px-2 py-0.5 bg-red-100 text-red-800 rounded-full text-xs font-bold">
                                {{ unreadCount }}
                            </span>
                            <span *ngIf="activeTab === 'inbox'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-indigo-600 to-purple-600"></span>
                        </button>
                        <button class="flex-1 px-6 py-4 text-sm font-medium transition-all duration-200 relative group"
                            [ngClass]="activeTab === 'sent' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            (click)="activeTab = 'sent'">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Sent
                            <span *ngIf="activeTab === 'sent'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-indigo-600 to-purple-600"></span>
                        </button>
                        <button class="flex-1 px-6 py-4 text-sm font-medium transition-all duration-200 relative group"
                            [ngClass]="activeTab === 'deleted' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            (click)="activeTab = 'deleted'">
                            <i class="fas fa-trash mr-2"></i>
                            Trash
                            <span *ngIf="deletedNotifications.length > 0"
                                class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs">
                                {{ deletedNotifications.length }}
                            </span>
                            <span *ngIf="activeTab === 'deleted'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-indigo-600 to-purple-600"></span>
                        </button>
                        <button class="flex-1 px-6 py-4 text-sm font-medium transition-all duration-200 relative group"
                            [ngClass]="activeTab === 'compose' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            (click)="activeTab = 'compose'">
                            <i class="fas fa-edit mr-2"></i>
                            Compose
                            <span *ngIf="activeTab === 'compose'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-indigo-600 to-purple-600"></span>
                        </button>
                        <button class="flex-1 px-6 py-4 text-sm font-medium transition-all duration-200 relative group"
                            [ngClass]="activeTab === 'stats' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            (click)="activeTab = 'stats'">
                            <i class="fas fa-chart-pie mr-2"></i>
                            Analytics
                            <span *ngIf="activeTab === 'stats'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-indigo-600 to-purple-600"></span>
                        </button>
                    </div>
                </div>

                <!-- Enhanced Toolbar -->
                <div class="bg-white rounded-2xl border border-indigo-100 shadow-lg p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <!-- Search with Dynamic Placeholder -->
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <div class="p-2 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-lg">
                                    <i class="fas fa-search text-indigo-600"></i>
                                </div>
                            </div>
                            <!-- Inbox Search -->
                            <input *ngIf="activeTab === 'inbox'" type="text"
                                placeholder="Search inbox by content, sender..." [(ngModel)]="searchTerm"
                                class="w-full pl-16 pr-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400" />

                            <!-- Sent Search -->
                            <input *ngIf="activeTab === 'sent'" type="text"
                                placeholder="Search sent messages by content, recipient..." [(ngModel)]="sentSearchTerm"
                                class="w-full pl-16 pr-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400" />

                            <!-- Deleted Search -->
                            <input *ngIf="activeTab === 'deleted'" type="text" placeholder="Search deleted messages..."
                                [(ngModel)]="deletedSearchTerm"
                                class="w-full pl-16 pr-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400" />

                            <!-- Default Search -->
                            <input *ngIf="activeTab !== 'inbox' && activeTab !== 'sent' && activeTab !== 'deleted'"
                                type="text" placeholder="Search notifications..." [(ngModel)]="searchTerm"
                                class="w-full pl-16 pr-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400" />
                        </div>

                        <div class="flex items-center gap-3">
                            <!-- Enhanced Filter Button -->
                            <button
                                class="inline-flex items-center gap-2 px-6 py-3.5 bg-white border-2 border-indigo-100 text-gray-700 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 transition-all duration-200 group relative"
                                (click)="showFilterModal = true">
                                <i class="fas fa-filter text-indigo-500 group-hover:scale-110 transition-transform"></i>
                                <span class="font-medium">Filter</span>
                                <span *ngIf="filterStatus !== 'all' || filterType !== 'all'"
                                    class="w-2.5 h-2.5 bg-indigo-600 rounded-full animate-pulse absolute -top-1 -right-1"></span>
                            </button>

                            <!-- Enhanced Mark All Read Button -->
                            <button *ngIf="unreadCount > 0"
                                class="inline-flex items-center gap-2 px-6 py-3.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl hover:from-green-600 hover:to-emerald-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                                (click)="markAllAsRead()">
                                <i class="fas fa-check-double"></i>
                                <span class="font-medium">Mark All Read</span>
                                <span class="ml-1 px-2 py-0.5 bg-white/20 rounded-full text-xs">{{ unreadCount }}</span>
                            </button>

                            <!-- Enhanced New Message Button -->
                            <button
                                class="inline-flex items-center gap-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3.5 rounded-xl shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 transform hover:-translate-y-0.5"
                                (click)="openComposeModal()">
                                <i class="fas fa-plus-circle text-lg"></i>
                                <span class="font-medium">New Message</span>
                            </button>
                        </div>
                    </div>

                    <!-- Active Filters Display -->
                    <div *ngIf="filterStatus !== 'all' || filterType !== 'all' || dateRange.start || dateRange.end"
                        class="flex items-center gap-2 mt-4 pt-4 border-t border-indigo-100">
                        <span class="text-xs text-gray-500">Active filters:</span>
                        <span *ngIf="filterStatus !== 'all'"
                            class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs">
                            Status: {{ filterStatus }}
                        </span>
                        <span *ngIf="filterType !== 'all'"
                            class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">
                            Type: {{ filterType }}
                        </span>
                        <span *ngIf="dateRange.start" class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">
                            From: {{ dateRange.start | date:'mediumDate' }}
                        </span>
                        <span *ngIf="dateRange.end" class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">
                            To: {{ dateRange.end | date:'mediumDate' }}
                        </span>
                        <button class="ml-auto text-xs text-red-600 hover:text-red-800 flex items-center gap-1"
                            (click)="clearFilters()">
                            <i class="fas fa-times"></i> Clear all
                        </button>
                    </div>
                </div>

                <!-- INBOX TAB - Enhanced -->
                <div *ngIf="activeTab === 'inbox'">
                    <div class="bg-white rounded-2xl border border-indigo-100 shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-indigo-100">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-inbox text-indigo-600"></i>
                                    Inbox
                                    <span class="ml-2 px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs">
                                        {{ displayedNotifications.length }} of {{ totalNotifications }}
                                    </span>

                                </h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-indigo-600 bg-white px-3 py-1.5 rounded-full shadow-sm">
                                        <i class="fas fa-clock mr-1"></i>
                                        Last updated: {{ formatTime(getCurrentDate()) }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div *ngIf="loading" class="p-12 text-center">
                            <div
                                class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-200 border-t-indigo-600">
                            </div>
                            <p class="mt-4 text-gray-500 font-medium">Loading your messages...</p>
                        </div>

                        <!-- Notifications List -->
                        <div *ngIf="!loading" class="divide-y divide-indigo-50">
                            <div *ngFor="let notification of displayedNotifications"
                                class="p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200 cursor-pointer group relative"
                                [ngClass]="{
                                'bg-gradient-to-r from-indigo-50/30 to-purple-50/30': notification.status === NotificationStatus.SENT || notification.status === NotificationStatus.DELIVERED,
                                'opacity-75': notification.status === NotificationStatus.DELETED
                            }" (click)="selectNotification(notification)">

                                <!-- Unread Indicator -->
                                <div *ngIf="notification.status !== NotificationStatus.READ"
                                    class="absolute left-0 top-1/2 -translate-y-1/2 w-1.5 h-10 bg-indigo-500 rounded-r-full">
                                </div>

                                <div class="flex items-start gap-4">
                                    <!-- Enhanced Icon with Status Badge -->
                                    <div class="flex-shrink-0 relative">
                                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-all"
                                            [ngClass]="{
                                                'bg-gradient-to-br from-blue-100 to-blue-50': notification.type === NotificationType.MESSAGE,
                                                'bg-gradient-to-br from-gray-100 to-gray-50': notification.type === NotificationType.SYSTEM,
                                                'bg-gradient-to-br from-red-100 to-red-50': notification.type === NotificationType.ALERT,
                                                'bg-gradient-to-br from-yellow-100 to-yellow-50': notification.type === NotificationType.REMINDER
                                             }">
                                            <i class="fas text-2xl" [ngClass]="{
                                                  'fa-envelope text-blue-600': notification.type === NotificationType.MESSAGE,
                                                  'fa-cog text-gray-600': notification.type === NotificationType.SYSTEM,
                                                  'fa-exclamation-triangle text-red-600': notification.type === NotificationType.ALERT,
                                                  'fa-bell text-yellow-600': notification.type === NotificationType.REMINDER
                                               }"></i>
                                        </div>
                                        <span *ngIf="notification.status === NotificationStatus.DELETED"
                                            class="absolute -bottom-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs">
                                            <i class="fas fa-trash"></i>
                                        </span>
                                    </div>

                                    <!-- Content -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3 flex-wrap">
                                                <h4 class="font-semibold text-gray-900 flex items-center gap-2">
                                                    {{ notification.subject || 'No Subject' }}
                                                    <span *ngIf="notification.status === NotificationStatus.SENT"
                                                        class="px-2.5 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium shadow-sm">
                                                        <i class="fas fa-clock mr-1"></i>New
                                                    </span>
                                                    <span *ngIf="notification.isEdited"
                                                        class="px-2.5 py-1 bg-amber-100 text-amber-800 rounded-full text-xs font-medium">
                                                        <i class="fas fa-pencil-alt mr-1"></i>Edited
                                                        <span *ngIf="notification.editedAt" class="ml-1 text-amber-600">
                                                            {{ formatTime(notification.editedAt) }}
                                                        </span>
                                                    </span>
                                                </h4>
                                            </div>
                                            <span
                                                class="text-sm text-gray-500 bg-white px-3 py-1.5 rounded-full shadow-sm">
                                                <i class="far fa-clock mr-1"></i>
                                                {{ formatTime(notification.createdAt) }}
                                            </span>
                                        </div>

                                        <!-- Message Content with Deleted State -->
                                        <p class="text-gray-700 mb-3"
                                            [ngClass]="{'text-gray-400 italic': notification.status === NotificationStatus.DELETED}">
                                            {{ notification.content }}
                                            <span *ngIf="notification.status === NotificationStatus.DELETED"
                                                class="ml-2 text-xs text-red-500">
                                                (Deleted)
                                            </span>
                                        </p>

                                        <!-- Meta Information -->
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4 text-sm">
                                                <span class="text-gray-600 flex items-center gap-1.5">
                                                    <i class="fas fa-user-circle text-indigo-500"></i>
                                                    From:
                                                    <span class="font-medium text-gray-900">
                                                        {{ getSenderDisplay(notification.senderId,
                                                        notification.senderRole) }}
                                                    </span>
                                                    <span class="text-gray-400 text-xs ml-1">
                                                        ({{ notification.senderRole | titlecase }})
                                                    </span>
                                                </span>
                                                <span class="px-3 py-1.5 rounded-full text-xs font-medium shadow-sm"
                                                    [ngClass]="getTypeBadgeClass(notification.type)">
                                                    <i
                                                        [class]="'fas mr-1 ' + getNotificationIcon(notification.type)"></i>
                                                    {{ notification.type }}
                                                </span>
                                            </div>

                                            <!-- Action Buttons - Enhanced -->
                                            <div
                                                class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                <!-- Edit Button - Show if editable -->
                                                <button *ngIf="canEditNotification(notification)"
                                                    class="p-2.5 text-amber-600 hover:text-white hover:bg-amber-500 rounded-xl transition-all duration-200 group/btn relative shadow-sm hover:shadow"
                                                    (click)="openEditModal(notification); $event.stopPropagation()"
                                                    title="Edit message">
                                                    <i class="fas fa-pencil-alt"></i>
                                                    <span
                                                        class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap">
                                                        Edit ({{ getTimeUntilEditExpiry(notification) }})
                                                    </span>
                                                </button>

                                                <!-- Mark as Read -->
                                                <button
                                                    *ngIf="notification.status !== NotificationStatus.READ && notification.status !== NotificationStatus.DELETED"
                                                    class="p-2.5 text-green-600 hover:text-white hover:bg-green-500 rounded-xl transition-all duration-200 group/btn relative shadow-sm hover:shadow"
                                                    (click)="markAsRead(notification.id!, $event)" title="Mark as read">
                                                    <i class="fas fa-check"></i>
                                                    <span
                                                        class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity whitespace-nowrap">
                                                        Mark as read
                                                    </span>
                                                </button>

                                                <!-- Reply Button -->
                                                <button *ngIf="notification.status !== NotificationStatus.DELETED"
                                                    class="p-2.5 text-purple-600 hover:text-white hover:bg-purple-500 rounded-xl transition-all duration-200 group/btn relative shadow-sm hover:shadow"
                                                    (click)="openReplyModal(notification); $event.stopPropagation()"
                                                    title="Reply">
                                                    <i class="fas fa-reply"></i>
                                                    <span
                                                        class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity">
                                                        Reply
                                                    </span>
                                                </button>

                                                <!-- View History Button -->
                                                <button
                                                    class="p-2.5 text-gray-600 hover:text-white hover:bg-gray-500 rounded-xl transition-all duration-200 group/btn relative shadow-sm hover:shadow"
                                                    (click)="loadNotificationWithLogs(notification.id!); $event.stopPropagation()"
                                                    title="View history">
                                                    <i class="fas fa-history"></i>
                                                    <span
                                                        class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity">
                                                        History
                                                    </span>
                                                </button>

                                                <!-- Soft Delete Button -->
                                                <button
                                                    *ngIf="canDeleteNotification(notification) && notification.status !== NotificationStatus.DELETED"
                                                    class="p-2.5 text-red-600 hover:text-white hover:bg-red-500 rounded-xl transition-all duration-200 group/btn relative shadow-sm hover:shadow"
                                                    (click)="softDeleteNotification(notification.id!, $event)"
                                                    title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                    <span
                                                        class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover/btn:opacity-100 transition-opacity">
                                                        Move to trash
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Empty State -->
                            <div *ngIf="displayedNotifications.length === 0" class="p-16 text-center">

                                <div
                                    class="w-24 h-24 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                                    <i class="fas fa-inbox text-4xl text-indigo-400"></i>
                                </div>
                                <h4 class="text-xl font-semibold text-gray-700 mb-2">Inbox Zero!</h4>
                                <p class="text-gray-500 max-w-md mx-auto mb-6">
                                    {{ searchTerm ? 'No notifications match your search criteria.' : 'You have no unread
                                    notifications. Time to enjoy
                                    the silence!' }}
                                </p>
                                <button *ngIf="!searchTerm"
                                    class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium shadow-lg hover:shadow-xl"
                                    (click)="openComposeModal()">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Compose New Message
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Load More -->
                        <div *ngIf="notifications.length < totalNotifications && displayedNotifications.length > 0"
                            class="p-4 text-center border-t border-indigo-100 bg-gradient-to-b from-white to-indigo-50/30">
                            <button
                                class="px-8 py-3 text-indigo-600 hover:text-white hover:bg-indigo-600 rounded-xl transition-all duration-200 font-medium border-2 border-indigo-200 hover:border-indigo-600 shadow-sm hover:shadow-lg flex items-center justify-center gap-2 mx-auto"
                                (click)="loadMore()" [disabled]="loadingMore">
                                <i class="fas fa-spinner fa-spin" *ngIf="loadingMore"></i>
                                <i class="fas fa-chevron-down" *ngIf="!loadingMore"></i>
                                {{ loadingMore ? 'Loading...' : 'Load More Messages' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SENT TAB - Enhanced -->
                <div *ngIf="activeTab === 'sent'">
                    <div class="bg-white rounded-2xl border border-indigo-100 shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-indigo-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-white rounded-lg shadow-sm">
                                        <i class="fas fa-paper-plane text-green-600"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800">Sent Messages</h3>
                                </div>
                                <span
                                    class="px-3 py-1.5 bg-white text-green-700 rounded-full text-xs font-medium shadow-sm">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    {{ displayedSentNotifications.length }} sent
                                </span>
                            </div>
                        </div>

                        <!-- Sent Messages Search -->
                        <div class="p-4 border-b border-indigo-100 bg-gray-50/50">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" placeholder="Search sent messages..." [(ngModel)]="sentSearchTerm"
                                    class="w-full pl-10 pr-4 py-2.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200" />
                            </div>
                        </div>

                        <div class="divide-y divide-indigo-50">
                            <div *ngFor="let notification of displayedSentNotifications; trackBy: trackByNotificationId"
                                class="p-6 hover:bg-gradient-to-r hover:from-green-50/30 hover:to-emerald-50/30 transition-all duration-200 group">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-12 h-12 bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-all">
                                            <i class="fas fa-check text-green-600 text-xl"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <h4 class="font-semibold text-gray-900">
                                                    To:
                                                    <span class="text-indigo-600">
                                                        {{ getRecipientDisplay(notification.recipientId,
                                                        notification.recipientRole) }}
                                                    </span>
                                                </h4>
                                                <span *ngIf="notification.isEdited"
                                                    class="px-2 py-1 bg-amber-100 text-amber-800 rounded-full text-xs font-medium">
                                                    <i class="fas fa-pencil-alt mr-1"></i>Edited
                                                </span>
                                            </div>
                                            <span
                                                class="text-sm text-gray-500 bg-white px-3 py-1.5 rounded-full shadow-sm">
                                                <i class="far fa-clock mr-1"></i>
                                                {{ formatTime(notification.createdAt) }}
                                            </span>
                                        </div>
                                        <p class="text-gray-700 mb-3">{{ notification.content }}</p>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3 text-sm">
                                                <span class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full">
                                                    <i class="fas fa-tag mr-1"></i>
                                                    {{ notification.type }}
                                                </span>
                                                <span class="px-3 py-1.5 rounded-full text-xs font-medium shadow-sm"
                                                    [ngClass]="getStatusBadgeClass(notification.status)">
                                                    <i class="fas fa-circle mr-1" [style.fontSize.px]="8"></i>
                                                    {{ notification.status }}
                                                </span>
                                                <span *ngIf="notification.readAt"
                                                    class="text-gray-500 flex items-center gap-1">
                                                    <i class="fas fa-eye text-green-500"></i>
                                                    Read {{ formatTime(notification.readAt) }}
                                                </span>
                                                <span *ngIf="notification.deliveredAt && !notification.readAt"
                                                    class="text-gray-500">
                                                    <i class="fas fa-check-circle text-blue-500 mr-1"></i>
                                                    Delivered
                                                </span>
                                            </div>

                                            <!-- Sent Message Actions -->
                                            <div
                                                class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button *ngIf="canEditNotification(notification)"
                                                    class="p-2 text-amber-600 hover:text-white hover:bg-amber-500 rounded-lg transition-all duration-200"
                                                    (click)="openEditModal(notification); $event.stopPropagation()"
                                                    title="Edit message">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </button>
                                                <button
                                                    *ngIf="canDeleteNotification(notification) && notification.status !== NotificationStatus.DELETED"
                                                    class="p-2 text-red-600 hover:text-white hover:bg-red-500 rounded-lg transition-all duration-200"
                                                    (click)="softDeleteNotification(notification.id!, $event)"
                                                    title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div *ngIf="displayedSentNotifications.length === 0" class="p-16 text-center">
                                <div
                                    class="w-24 h-24 bg-gradient-to-br from-green-100 to-emerald-100 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-paper-plane text-4xl text-green-400"></i>
                                </div>
                                <h4 class="text-xl font-semibold text-gray-700 mb-2">No sent messages</h4>
                                <p class="text-gray-500 mb-6">{{ sentSearchTerm ? 'No messages match your search
                                    criteria.' : 'Your
                                    outgoing messages will appear here' }}</p>
                                <button *ngIf="!sentSearchTerm"
                                    class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all font-medium shadow-lg"
                                    (click)="activeTab = 'compose'">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    Compose Message
                                </button>
                            </div>
                        </div>

                        <!-- Load More for Sent -->
                        <div *ngIf="sentNotifications.length < totalSentNotifications && displayedSentNotifications.length > 0"
                            class="p-4 text-center border-t border-indigo-100">
                            <button
                                class="px-6 py-2.5 text-green-600 hover:text-white hover:bg-green-600 rounded-xl transition-all duration-200 font-medium border-2 border-green-200 hover:border-green-600"
                                (click)="loadMoreSent()" [disabled]="loadingSent">
                                <i class="fas fa-spinner fa-spin mr-2" *ngIf="loadingSent"></i>
                                {{ loadingSent ? 'Loading...' : 'Load More' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- DELETED/TRASH TAB - New -->
                <div *ngIf="activeTab === 'deleted'">
                    <div class="bg-white rounded-2xl border border-indigo-100 shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-gray-50 to-red-50 px-6 py-4 border-b border-indigo-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-white rounded-lg shadow-sm">
                                        <i class="fas fa-trash text-red-500"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-800">Trash</h3>
                                </div>
                                <span
                                    class="px-3 py-1.5 bg-white text-red-600 rounded-full text-xs font-medium shadow-sm">
                                    <i class="fas fa-trash mr-1"></i>
                                    {{ deletedNotifications.length }} deleted
                                </span>
                            </div>
                        </div>

                        <!-- Trash Search -->
                        <div class="p-4 border-b border-indigo-100 bg-gray-50/50">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" placeholder="Search deleted messages..."
                                    [(ngModel)]="deletedSearchTerm"
                                    class="w-full pl-10 pr-4 py-2.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200" />
                            </div>
                        </div>

                        <div class="divide-y divide-indigo-50">
                            <div *ngFor="let notification of filteredDeletedNotifications"
                                class="p-6 hover:bg-gray-50/50 transition-all duration-200 group">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0">
                                        <div
                                            class="w-12 h-12 bg-gradient-to-br from-gray-100 to-red-50 rounded-2xl flex items-center justify-center">
                                            <i class="fas fa-trash-alt text-red-400 text-xl"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <h4 class="font-semibold text-gray-700">
                                                    {{ notification.subject || '[Deleted]' }}
                                                </h4>
                                                <span
                                                    class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                                                    <i class="fas fa-trash mr-1"></i>Deleted
                                                </span>
                                            </div>
                                            <span class="text-sm text-gray-500">
                                                {{ formatTime(notification.createdAt) }}
                                            </span>
                                        </div>
                                        <p class="text-gray-500 italic mb-3">
                                            {{ notification.content }}
                                        </p>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4 text-sm text-gray-500">
                                                <span>
                                                    <i class="fas fa-user mr-1"></i>
                                                    From: {{ getSenderDisplay(notification.senderId,
                                                    notification.senderRole) }}
                                                </span>
                                                <span>
                                                    <i class="fas fa-user mr-1"></i>
                                                    To: {{ getRecipientDisplay(notification.recipientId,
                                                    notification.recipientRole) }}
                                                </span>
                                            </div>

                                            <!-- Trash Actions -->
                                            <div class="flex items-center gap-2">
                                                <button
                                                    *ngIf="canDeleteNotification(notification) && canPermanentDelete()"
                                                    class="px-3 py-1.5 text-red-600 hover:text-white hover:bg-red-600 rounded-lg transition-all duration-200 text-sm font-medium border border-red-200 hover:border-red-600"
                                                    (click)="permanentDeleteNotification(notification.id!, $event)">
                                                    <i class="fas fa-trash-alt mr-1"></i>
                                                    Permanent Delete
                                                </button>
                                                <button
                                                    class="px-3 py-1.5 text-indigo-600 hover:text-white hover:bg-indigo-600 rounded-lg transition-all duration-200 text-sm font-medium border border-indigo-200 hover:border-indigo-600"
                                                    (click)="restoreNotification(notification.id!, $event)">
                                                    <i class="fas fa-undo mr-1"></i>
                                                    Restore
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div *ngIf="filteredDeletedNotifications.length === 0" class="p-16 text-center">
                                <div
                                    class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-50 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-trash text-4xl text-gray-400"></i>
                                </div>
                                <h4 class="text-xl font-semibold text-gray-700 mb-2">Trash is empty</h4>
                                <p class="text-gray-500">Deleted messages will appear here</p>
                            </div>
                        </div>

                        <!-- Load More for Trash -->
                        <div *ngIf="deletedNotifications.length >= pageSize"
                            class="p-4 text-center border-t border-indigo-100">
                            <button
                                class="px-6 py-2.5 text-gray-600 hover:text-white hover:bg-gray-600 rounded-xl transition-all duration-200 font-medium border-2 border-gray-200"
                                (click)="loadMoreDeleted()" [disabled]="loadingDeleted">
                                <i class="fas fa-spinner fa-spin mr-2" *ngIf="loadingDeleted"></i>
                                {{ loadingDeleted ? 'Loading...' : 'Load More' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- COMPOSE TAB - Enhanced -->
                <div *ngIf="activeTab === 'compose'"
                    class="bg-white rounded-2xl border border-indigo-100 shadow-lg p-6">
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-xl mb-6">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-white rounded-xl shadow-md">
                                <i class="fas fa-edit text-indigo-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Compose New Message</h3>
                                <p class="text-sm text-gray-600 mt-1">Fill in the details to send a notification</p>
                            </div>
                        </div>
                    </div>

                    <form [formGroup]="composeForm" class="space-y-6">
                        <!-- Recipient Type with Icons -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-user-tag text-indigo-500"></i>
                                    Recipient Type
                                </label>
                                <select formControlName="recipientType"
                                    class="w-full px-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 appearance-none"
                                    (change)="onRecipientTypeChange()">
                                    <option value="teacher"> Teacher</option>
                                    <option value="guardian"> Guardian</option>
                                    <option value="admin"> Admin</option>
                                </select>
                            </div>

                            <!-- Recipient Selection -->
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-user text-indigo-500"></i>
                                    Select Recipient
                                </label>
                                <select formControlName="recipientId"
                                    class="w-full px-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700">
                                    <option value="" disabled>Choose a recipient...</option>
                                    <option *ngFor="let recipient of getFilteredRecipients()" [value]="recipient.id">
                                        {{ getRecipientName(recipient) }} ({{ getRecipientIdentifier(recipient) }})
                                    </option>
                                </select>
                                <div *ngIf="composeForm.get('recipientId')?.touched && composeForm.get('recipientId')?.invalid"
                                    class="text-sm text-red-600 flex items-center gap-1 mt-1">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Please select a recipient
                                </div>
                            </div>
                        </div>

                        <!-- Subject -->
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <i class="fas fa-heading text-indigo-500"></i>
                                Subject
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-envelope text-gray-400"></i>
                                </div>
                                <input formControlName="subject" type="text" placeholder="Enter message subject"
                                    class="w-full pl-12 pr-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400" />
                            </div>
                        </div>

                        <!-- Message Type with Visual Cards -->
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <i class="fas fa-tag text-indigo-500"></i>
                                Message Type
                            </label>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="relative">
                                    <input type="radio" formControlName="type" [value]="NotificationType.MESSAGE"
                                        id="type-message" class="sr-only peer">
                                    <label for="type-message"
                                        class="flex flex-col items-center justify-center p-4 bg-white border-2 border-indigo-100 rounded-xl cursor-pointer peer-checked:border-indigo-600 peer-checked:bg-indigo-50 hover:bg-indigo-50/50 transition-all">
                                        <i class="fas fa-envelope text-2xl text-indigo-600 mb-2"></i>
                                        <span class="text-sm font-medium text-gray-700">Message</span>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" formControlName="type" [value]="NotificationType.ALERT"
                                        id="type-alert" class="sr-only peer">
                                    <label for="type-alert"
                                        class="flex flex-col items-center justify-center p-4 bg-white border-2 border-indigo-100 rounded-xl cursor-pointer peer-checked:border-red-600 peer-checked:bg-red-50 hover:bg-red-50/50 transition-all">
                                        <i class="fas fa-exclamation-triangle text-2xl text-red-600 mb-2"></i>
                                        <span class="text-sm font-medium text-gray-700">Alert</span>
                                    </label>
                                </div>
                                <div class="relative">
                                    <input type="radio" formControlName="type" [value]="NotificationType.REMINDER"
                                        id="type-reminder" class="sr-only peer">
                                    <label for="type-reminder"
                                        class="flex flex-col items-center justify-center p-4 bg-white border-2 border-indigo-100 rounded-xl cursor-pointer peer-checked:border-yellow-600 peer-checked:bg-yellow-50 hover:bg-yellow-50/50 transition-all">
                                        <i class="fas fa-bell text-2xl text-yellow-600 mb-2"></i>
                                        <span class="text-sm font-medium text-gray-700">Reminder</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Content with Rich Editor Feel -->
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <i class="fas fa-align-left text-indigo-500"></i>
                                Message Content
                            </label>
                            <div class="relative">
                                <textarea formControlName="content" rows="6" placeholder="Type your message here..."
                                    class="w-full px-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400 resize-none"></textarea>
                                <div
                                    class="absolute bottom-3 right-3 text-xs px-2 py-1 bg-gray-100 rounded-full text-gray-600">
                                    {{ composeForm.get('content')?.value?.length || 0 }}/500
                                </div>
                            </div>
                        </div>

                        <!-- Attachment URL -->
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <i class="fas fa-paperclip text-indigo-500"></i>
                                Attachment URL (Optional)
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-link text-gray-400"></i>
                                </div>
                                <input formControlName="attachmentUrl" type="url"
                                    placeholder="https://example.com/file.pdf"
                                    class="w-full pl-12 pr-4 py-3.5 bg-white border-2 border-indigo-100 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 text-gray-700 placeholder-gray-400" />
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-end gap-3 pt-6 border-t border-indigo-100">
                            <button type="button"
                                class="px-8 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all font-medium flex items-center gap-2"
                                (click)="activeTab = 'inbox'">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="button"
                                class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium flex items-center gap-2"
                                [disabled]="composeForm.invalid"
                                [ngClass]="{'opacity-50 cursor-not-allowed': composeForm.invalid}"
                                (click)="sendNotification()">
                                <i class="fas fa-paper-plane"></i>
                                Send Message
                            </button>
                        </div>
                    </form>
                </div>

                <!-- STATISTICS TAB - Enhanced Analytics -->
                <div *ngIf="activeTab === 'stats'">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Notification Distribution Chart -->
                        <div
                            class="bg-white rounded-2xl border border-indigo-100 shadow-lg p-6 hover:shadow-xl transition-all">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <div class="p-2 bg-indigo-100 rounded-lg">
                                        <i class="fas fa-chart-pie text-indigo-600"></i>
                                    </div>
                                    Notification Distribution
                                </h3>
                                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                                    {{ formatTime(getCurrentDate()) }}
                                </span>
                            </div>
                            <div class="aspect-square max-w-sm mx-auto">
                                <canvas baseChart [data]="notificationChartData" [options]="chartOptions"
                                    chartType="doughnut">
                                </canvas>
                            </div>
                            <div class="mt-6 space-y-3 bg-gray-50 p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                        <span class="text-sm text-gray-700">Unread Messages</span>
                                    </div>
                                    <span class="font-semibold text-gray-900">
                                        {{ stats?.unreadReceived || 0 }}
                                        <span class="text-xs text-gray-500 ml-1">({{ unreadPercentage | number:'1.0-1'
                                            }}%)</span>
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                        <span class="text-sm text-gray-700">Read Messages</span>
                                    </div>
                                    <span class="font-semibold text-gray-900">
                                        {{ (stats?.totalReceived || 0) - (stats?.unreadReceived || 0) }}
                                        <span class="text-xs text-gray-500 ml-1">({{ readPercentage | number:'1.0-1'
                                            }}%)</span>
                                    </span>
                                </div>
                                <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                        <span class="text-sm text-gray-700 font-medium">Total Sent</span>
                                    </div>
                                    <span class="font-semibold text-gray-900">{{ stats?.totalSent || 0 }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Chart -->
                        <div
                            class="bg-white rounded-2xl border border-indigo-100 shadow-lg p-6 hover:shadow-xl transition-all">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <div class="p-2 bg-purple-100 rounded-lg">
                                        <i class="fas fa-chart-line text-purple-600"></i>
                                    </div>
                                    Weekly Activity
                                </h3>
                                <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                                    Last 7 days
                                </span>
                            </div>
                            <div class="aspect-square max-w-sm mx-auto">
                                <canvas baseChart [data]="timelineChartData" [options]="lineChartOptions"
                                    chartType="line">
                                </canvas>
                            </div>
                        </div>

                        <!-- Enhanced Response Metrics -->
                        <div
                            class="bg-white rounded-2xl border border-indigo-100 shadow-lg p-6 lg:col-span-2 hover:shadow-xl transition-all">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <div class="p-2 bg-amber-100 rounded-lg">
                                        <i class="fas fa-chart-bar text-amber-600"></i>
                                    </div>
                                    Performance Metrics
                                </h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full">
                                        <i class="fas fa-calendar mr-1"></i>
                                        This Week
                                    </span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div class="p-5 bg-gradient-to-br from-indigo-50 to-indigo-100/50 rounded-xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-indigo-700">Response Rate</span>
                                        <div class="p-1.5 bg-indigo-200 rounded-lg">
                                            <i class="fas fa-reply-all text-indigo-700 text-xs"></i>
                                        </div>
                                    </div>
                                    <p class="text-3xl font-bold text-indigo-700">{{ responseRate | number:'1.0-1' }}%
                                    </p>
                                    <div class="mt-2 w-full bg-indigo-200 rounded-full h-1.5">
                                        <div class="bg-indigo-600 h-1.5 rounded-full" [style.width.%]="responseRate">
                                        </div>
                                    </div>
                                    <p class="text-xs text-indigo-600 mt-2"> 12% vs last week</p>
                                </div>

                                <div class="p-5 bg-gradient-to-br from-green-50 to-green-100/50 rounded-xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-green-700">Avg Response Time</span>
                                        <div class="p-1.5 bg-green-200 rounded-lg">
                                            <i class="fas fa-clock text-green-700 text-xs"></i>
                                        </div>
                                    </div>
                                    <p class="text-3xl font-bold text-green-700">2.5 hrs</p>
                                    <div class="flex items-center gap-1 mt-2">
                                        <i class="fas fa-arrow-down text-green-600 text-xs"></i>
                                        <span class="text-xs text-green-600">15% faster than last week</span>
                                    </div>
                                </div>

                                <div class="p-5 bg-gradient-to-br from-purple-50 to-purple-100/50 rounded-xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-purple-700">Active Conversations</span>
                                        <div class="p-1.5 bg-purple-200 rounded-lg">
                                            <i class="fas fa-comments text-purple-700 text-xs"></i>
                                        </div>
                                    </div>
                                    <p class="text-3xl font-bold text-purple-700">{{ conversations.length }}</p>
                                    <p class="text-xs text-purple-600 mt-2">Avg. 4.2 messages per thread</p>
                                </div>

                                <div class="p-5 bg-gradient-to-br from-amber-50 to-amber-100/50 rounded-xl">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-amber-700">Engagement Score</span>
                                        <div class="p-1.5 bg-amber-200 rounded-lg">
                                            <i class="fas fa-trophy text-amber-700 text-xs"></i>
                                        </div>
                                    </div>
                                    <p class="text-3xl font-bold text-amber-700">86</p>
                                    <p class="text-xs text-amber-600 mt-2"> 8 points from last week</p>
                                </div>
                            </div>

                            <div class="mt-6 pt-6 border-t border-indigo-100">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <span class="text-xs text-gray-500">Messages Sent</span>
                                        <p class="text-lg font-semibold text-gray-800">{{ stats?.totalSent || 0 }}</p>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-500">Messages Received</span>
                                        <p class="text-lg font-semibold text-gray-800">{{ stats?.totalReceived || 0 }}
                                        </p>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-500">Read Rate</span>
                                        <p class="text-lg font-semibold text-green-600">{{ readPercentage |
                                            number:'1.0-1' }}%</p>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-500">Deleted</span>
                                        <p class="text-lg font-semibold text-gray-800">{{ deletedNotifications.length }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- COMPOSE MODAL - Enhanced -->
<div *ngIf="showComposeModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"
    (click)="showComposeModal = false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all animate-slideUp"
        (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-5 border-b border-indigo-100 rounded-t-2xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl shadow-lg">
                    <i class="fas fa-edit text-white text-lg"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">Compose New Message</h3>
                    <p class="text-sm text-gray-600 mt-1">Send a notification to any user in the system</p>
                </div>
                <button class="p-2 hover:bg-white/50 rounded-lg transition-colors" (click)="showComposeModal = false">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6 max-h-[70vh] overflow-y-auto">
            <form [formGroup]="composeForm" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Recipient Type</label>
                        <select formControlName="recipientType"
                            class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200">
                            <option value="teacher">Teacher</option>
                            <option value="guardian">Guardian</option>

                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Select Recipient</label>
                        <select formControlName="recipientId"
                            class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200">
                            <option value="" disabled>Choose a recipient...</option>
                            <option *ngFor="let recipient of getFilteredRecipients()" [value]="recipient.id">
                                {{ getRecipientName(recipient) }}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Subject</label>
                    <input formControlName="subject" type="text" placeholder="Enter message subject"
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200" />
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Message</label>
                    <textarea formControlName="content" rows="4" placeholder="Type your message..."
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 resize-none"></textarea>
                    <div class="flex justify-end">
                        <span class="text-xs text-gray-500">
                            {{ composeForm.get('content')?.value?.length || 0 }}/500
                        </span>
                    </div>
                </div>
            </form>
        </div>

        <!-- Modal Footer -->
        <div class="bg-gray-50/80 backdrop-blur-sm px-6 py-4 border-t border-gray-200 rounded-b-2xl">
            <div class="flex justify-end gap-3">
                <button type="button"
                    class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 hover:border-gray-400 transition-all font-medium"
                    (click)="showComposeModal = false">
                    Cancel
                </button>
                <button type="button"
                    class="px-6 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium flex items-center gap-2"
                    [disabled]="composeForm.invalid" [ngClass]="{'opacity-50 cursor-not-allowed': composeForm.invalid}"
                    (click)="sendNotification()">
                    <i class="fas fa-paper-plane"></i>
                    Send Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT MODAL - New -->
<div *ngIf="showEditModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"
    (click)="showEditModal = false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl" (click)="$event.stopPropagation()">
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 px-6 py-5 border-b border-amber-100 rounded-t-2xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl shadow-lg">
                    <i class="fas fa-pencil-alt text-white text-lg"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">Edit Message</h3>
                    <p class="text-sm text-amber-600 mt-1 flex items-center gap-2">
                        <i class="fas fa-clock"></i>
                        Time remaining: {{ getTimeUntilEditExpiry(selectedNotification!) }}
                    </p>
                </div>
                <button class="p-2 hover:bg-white/50 rounded-lg transition-colors" (click)="showEditModal = false">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <form [formGroup]="editForm" class="space-y-5">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Subject</label>
                    <input formControlName="subject" type="text"
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all duration-200" />
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Content</label>
                    <textarea formControlName="content" rows="4"
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all duration-200 resize-none"></textarea>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Attachment URL</label>
                    <input formControlName="attachmentUrl" type="url" placeholder="https://..."
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all duration-200" />
                </div>
            </form>
        </div>

        <div class="bg-gray-50/80 px-6 py-4 border-t border-gray-200 rounded-b-2xl">
            <div class="flex justify-end gap-3">
                <button
                    class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 transition-all font-medium"
                    (click)="showEditModal = false">
                    Cancel
                </button>
                <button
                    class="px-6 py-2.5 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-xl shadow-lg hover:shadow-xl hover:from-amber-700 hover:to-orange-700 transition-all font-medium"
                    [disabled]="editForm.invalid" [ngClass]="{'opacity-50 cursor-not-allowed': editForm.invalid}"
                    (click)="updateNotification()">
                    <i class="fas fa-save mr-2"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- REPLY MODAL - Enhanced -->
<div *ngIf="showReplyModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"
    (click)="showReplyModal = false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg" (click)="$event.stopPropagation()">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-5 border-b border-indigo-100 rounded-t-2xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl shadow-lg">
                    <i class="fas fa-reply text-white text-lg"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">Reply to Message</h3>
                    <p class="text-sm text-gray-600 mt-1">Re: {{ selectedNotification?.subject | slice:0:50 }}</p>
                </div>
                <button class="p-2 hover:bg-white/50 rounded-lg transition-colors" (click)="showReplyModal = false">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <p class="text-xs text-gray-500 mb-2">Original message:</p>
                <p class="text-gray-800">{{ selectedNotification?.content }}</p>
                <p class="text-xs text-gray-400 mt-2">
                    From: {{ getSenderDisplay(selectedNotification?.senderId!, selectedNotification?.senderRole!) }}
                     {{ formatTime(selectedNotification?.createdAt) }}
                </p>
            </div>

            <form [formGroup]="replyForm">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Your Reply</label>
                    <textarea formControlName="content" rows="4" placeholder="Type your reply..."
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 resize-none"></textarea>
                </div>
            </form>
        </div>

        <div class="bg-gray-50/80 px-6 py-4 border-t border-gray-200 rounded-b-2xl">
            <div class="flex justify-end gap-3">
                <button
                    class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 transition-all font-medium"
                    (click)="showReplyModal = false">
                    Cancel
                </button>
                <button
                    class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-indigo-700 transition-all font-medium"
                    [disabled]="replyForm.invalid" [ngClass]="{'opacity-50 cursor-not-allowed': replyForm.invalid}"
                    (click)="sendReply()">
                    <i class="fas fa-reply mr-2"></i>
                    Send Reply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- LOGS/HISTORY MODAL - New -->
<div *ngIf="showLogsModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"
    (click)="showLogsModal = false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl" (click)="$event.stopPropagation()">
        <div class="bg-gradient-to-r from-gray-50 to-indigo-50 px-6 py-5 border-b border-indigo-100 rounded-t-2xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-gray-600 to-indigo-600 rounded-xl shadow-lg">
                    <i class="fas fa-history text-white text-lg"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">Message History</h3>
                    <p class="text-sm text-gray-600 mt-1">
                        Tracking all actions on this notification
                    </p>
                </div>
                <button class="p-2 hover:bg-white/50 rounded-lg transition-colors" (click)="showLogsModal = false">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
        </div>

        <div class="p-6 max-h-[60vh] overflow-y-auto">
            <div *ngIf="loadingLogs" class="text-center py-8">
                <div
                    class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-200 border-t-indigo-600">
                </div>
                <p class="mt-3 text-gray-500">Loading history...</p>
            </div>

            <div *ngIf="!loadingLogs" class="space-y-4">
                <div *ngFor="let log of notificationLogs"
                    class="relative flex gap-4 pb-4 border-b border-gray-100 last:border-0">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center" [ngClass]="{
                                'bg-blue-100': log.action === NotificationAction.SENT,
                                'bg-green-100': log.action === NotificationAction.READ || log.action === NotificationAction.DELIVERED,
                                'bg-amber-100': log.action === NotificationAction.EDITED,
                                'bg-red-100': log.action === NotificationAction.DELETED,
                                'bg-purple-100': log.action === NotificationAction.ARCHIVED
                             }">
                            <i class="fas" [ngClass]="getActionIcon(log.action)"
                                [class]="getActionColor(log.action)"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-900">
                                {{ log.action | titlecase }}
                            </span>
                            <span class="text-xs text-gray-500">
                                {{ formatTime(log.createdAt) }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600">
                            Performed by: {{ getRecipientDisplay(log.performedBy, log.performedByRole) }}
                        </p>
                        <div *ngIf="log.metadata" class="mt-2 text-xs bg-gray-50 p-2 rounded-lg">
                            <div *ngIf="log.metadata.previousContent" class="text-gray-600">
                                <span class="font-medium">Previous:</span> {{ log.metadata.previousContent | slice:0:100
                                }}
                            </div>
                            <div *ngIf="log.metadata.updatedContent" class="text-green-600 mt-1">
                                <span class="font-medium">Updated:</span> {{ log.metadata.updatedContent | slice:0:100
                                }}
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="notificationLogs.length === 0" class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-history text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-500">No history available for this message</p>
                </div>
            </div>
        </div>

        <div class="bg-gray-50/80 px-6 py-4 border-t border-gray-200 rounded-b-2xl">
            <div class="flex justify-end">
                <button
                    class="px-6 py-2.5 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition-all font-medium"
                    (click)="showLogsModal = false">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- THREAD MODAL - Enhanced -->
<div *ngIf="showThreadModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"
    (click)="showThreadModal = false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl" (click)="$event.stopPropagation()">
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-5 border-b border-indigo-100 rounded-t-2xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl shadow-lg">
                    <i class="fas fa-comments text-white text-lg"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">Conversation Thread</h3>
                    <p class="text-sm text-gray-600 mt-1">
                        With: {{ getRecipientDisplay(selectedConversation?.participantId!,
                        selectedConversation?.participantRole!) }}
                    </p>
                </div>
                <button class="p-2 hover:bg-white/50 rounded-lg transition-colors" (click)="showThreadModal = false">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
        </div>

        <div #threadContainer class="p-6 max-h-[60vh] overflow-y-auto space-y-4">
            <div *ngFor="let message of conversationThread" class="flex gap-3"
                [ngClass]="{'flex-row-reverse': message.senderId === currentUserId}">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                        [ngClass]="message.senderId === currentUserId ? 'bg-indigo-100' : 'bg-gray-100'">
                        <i class="fas fa-user-circle"
                            [ngClass]="message.senderId === currentUserId ? 'text-indigo-600' : 'text-gray-600'"></i>
                    </div>
                </div>
                <div class="flex-1 max-w-[80%]">
                    <div class="bg-white rounded-2xl p-4 shadow-sm border"
                        [ngClass]="message.senderId === currentUserId ? 'border-indigo-200 bg-indigo-50/50' : 'border-gray-200'">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-900">
                                {{ message.senderId === currentUserId ? 'You' : getSenderDisplay(message.senderId,
                                message.senderRole) }}
                            </span>
                            <span class="text-xs text-gray-500">
                                {{ formatTime(message.createdAt) }}
                            </span>
                        </div>
                        <p class="text-gray-700 text-sm">{{ message.content }}</p>
                        <div *ngIf="message.isEdited" class="mt-1 text-xs text-amber-600">
                            <i class="fas fa-pencil-alt mr-1"></i>Edited
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-200">
                <form [formGroup]="replyForm" class="flex gap-3">
                    <textarea formControlName="content" rows="2" placeholder="Type your reply..."
                        class="flex-1 px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200 resize-none text-sm"></textarea>
                    <button
                        class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium h-fit"
                        [disabled]="replyForm.invalid" [ngClass]="{'opacity-50 cursor-not-allowed': replyForm.invalid}"
                        (click)="replyInThread()">
                        <i class="fas fa-reply mr-2"></i>
                        Reply
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- FILTER MODAL - Enhanced -->
<div *ngIf="showFilterModal"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fadeIn"
    (click)="showFilterModal = false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md" (click)="$event.stopPropagation()">
        <div class="bg-gradient-to-r from-gray-50 to-indigo-50 px-6 py-5 border-b border-indigo-100 rounded-t-2xl">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-gradient-to-br from-gray-600 to-indigo-600 rounded-xl shadow-lg">
                    <i class="fas fa-filter text-white text-lg"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800">Filter Notifications</h3>
                    <p class="text-sm text-gray-600 mt-1">Refine your notification list</p>
                </div>
                <button class="p-2 hover:bg-white/50 rounded-lg transition-colors" (click)="showFilterModal = false">
                    <i class="fas fa-times text-gray-500"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <form [formGroup]="filterForm" class="space-y-5">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select formControlName="status"
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200">
                        <option value="all"> All Status</option>
                        <option value="sent"> Sent</option>
                        <option value="delivered"> Delivered</option>
                        <option value="read"> Read</option>
                        <option value="deleted"> Deleted</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Type</label>
                    <select formControlName="type"
                        class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200">
                        <option value="all"> All Types</option>
                        <option value="message"> Message</option>
                        <option value="system"> System</option>
                        <option value="alert"> Alert</option>
                        <option value="reminder"> Reminder</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Date Range</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <span class="text-xs text-gray-500 block mb-1">From</span>
                            <input formControlName="startDate" type="date"
                                class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200" />
                        </div>
                        <div>
                            <span class="text-xs text-gray-500 block mb-1">To</span>
                            <input formControlName="endDate" type="date"
                                class="w-full px-4 py-3 bg-white border-2 border-gray-200 rounded-xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-50 transition-all duration-200" />
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="bg-gray-50/80 px-6 py-4 border-t border-gray-200 rounded-b-2xl">
            <div class="flex justify-end gap-3">
                <button
                    class="px-6 py-2.5 text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all font-medium"
                    (click)="clearFilters()">
                    Clear All
                </button>
                <button
                    class="px-6 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium"
                    (click)="applyFilters()">
                    <i class="fas fa-check mr-2"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>